# 要件定義書：注目特許仕分けくん

## 1. ゴールと前提

- **ゴール**：発明アイデアに対し、各JSON特許を **二値判定（hit/miss）** し、**短いヒット理由（原文の短い引用＋出典）** を付して一覧化する。
- **前提**：
  - 架空特許の **JSONL** と、模範回答（ラベル） **JSONL** が既に存在（評価用ゴールドセット）。
  - 本仕組みは初期スクリーニング用途。法的最終判断・弱点可視化はスコープ外。
  - MVPでは **TopK絞り込みなし**、**合成式は LLM\_confidence のみ**、**エビデンス検証オフ**。

## 2. スコープ

- **対象**：液体分離設備に関する発明アイデアと、先行特許JSON群の照合。
- **出力**：注目候補の抽出（hit優先）、ヒット理由の簡潔提示。
- **除外**：未カバー要素の抽出、クレームチャート作成、詳細な進歩性評価。

## 3. 入力仕様

### 3.1 発明アイデア（テキスト or JSON）

任意キー：`title, problem, solution, effects, key_elements[], constraints`

### 3.2 先行特許（1件=1JSON）

- **必須**：`publication_number, title, assignee, pub_date, claims[], abstract`
- **任意**：`description[] (id推奨), cpc, ipc, legal_status, citations_forward, url_hint`
- `claims[]`要素：`{ no: <int>, text: <string>, is_independent: <bool> }`

> 備考：評価用ゴールドセットは JSONL（1行=1特許）で提供。ラベルJSONLは `publication_number` と `gold_label` を対応付ける。

## 4. 出力仕様

### 4.1 CSV（一覧）

```
rank, pub_number, title, assignee, pub_date, decision, LLM_confidence,
hit_reason_1, hit_src_1, hit_reason_2, hit_src_2, url_hint
```

### 4.2 JSONL（詳細、1行=1特許）

```json
{
  "pub_number": "JP2025-xxxxxxA",
  "decision": "hit",
  "LLM_confidence": 0.82,
  "reasons": [
    {"quote": "差圧に基づくポンプ制御", "source": {"field": "claim", "locator": "claim 1"}},
    {"quote": "閾値を超えた場合に停止", "source": {"field": "abstract", "locator": "sent 2"}}
  ],
  "flags": {"verified": false, "used_retrieval": false, "used_topk": false}
}
```

## 5. 判定ロジック（MVP）

- **LLM使用**：
  1. 発明要旨化（短文＋キーワード）
  2. 特許要旨化（独立請求項＋抄録）
  3. 当たり/外れ二値判定：`decision (hit|miss)`, `LLM_confidence (0..1)`, `reasons (<=2)`
- **LLM非使用**：入力JSONの正規化・抽出、CSV/JSONL出力、ログ記録。
- **最終スコア**：`final_score = LLM_confidence`（同点は `pub_number` などで安定ソート）。

## 6. 処理フロー（MVP）

1. JSONロード/正規化（全半角・大小・単位など）
2. 抽出：`claim 1`（独立）＋ `abstract`（必要に応じ代表従属）
3. LLM：発明要旨化（1回）／特許要旨化（各件）
4. LLM：二値判定＋ヒット理由（引用<=12語、最大2件）
5. 並び替え：`LLM_confidence` 降順（タイブレーク固定）
6. CSV/JSONLに出力、ログ保存

## 7. ディレクトリ構成

```
project-root/
├─ docs/
│  ├─ requirements.md                # 本書
│  └─ prompts/                       # 生成プロンプト一式（既存）
├─ src/
│  ├─ core/                          # normalize, extract, export
│  ├─ llm/                           # client, prompts, pipeline
│  ├─ ranking/                       # LLM_confのみの並べ替え
│  ├─ retrieval/                     # 将来拡張（初期は未使用）
│  └─ verify/                        # 将来拡張（初期は未使用）
├─ tests/
│  ├─ data/                          # 架空特許JSONL・ラベルJSONL
│  ├─ unit/                          # 抽出/並べ替え など
│  └─ integration/                   # E2E（MVPフロー）
├─ archive/
│  ├─ logs/                          # 実行ログ
│  └─ outputs/                       # 過去のCSV/JSONL
└─ README.md
```

## 8. 設定（初期値）

```yaml
run:
  use_topk: false
  use_retrieval_score: false
  verify_quotes: false
llm:
  temperature: 0.0
  response_format: json
  max_tokens: 320
ranking:
  method: "llm_only"  # final = LLM_confidence
io:
  out_csv: outputs/attention_patents.csv
  out_jsonl: outputs/details.jsonl
```

## 9. 評価（MVP）

- **正解照合**：ラベルJSONL（hit/borderline/miss）を参照。
  - システム出力は hit/miss のみ。`borderline` は**要精査**として運用上ヒトレビュー対象。
- **指標**：Precision\@TopN、Recall\@TopN、並びの安定性（同点処理）。

## 10. 将来拡張（参考：必要時のみ実装）

> いずれも **意味ベース** を採用し、キーワード偏重手法（例：BM25）は用いない。

- **TopK絞り込み**：件数増大時に、意味的関連度で上位候補へ圧縮（MVP未実装）。
- **エビデンス検証**：ヒット理由の引用が実際に該当範囲に存在するかを機械照合（MVP未実装）。
- **retrieval\_score追加**：意味的近さの補助スコアを `final_score` に加算し順位安定化（MVP未実装）。

## 11. 受け入れ基準

- 全件に `decision` と `LLM_confidence`、最大2件の `reasons` が付与されている。
- CSV/JSONLのカラム・キーが本要件に一致。
- 再実行で並び順が安定（同点のタイブレーク規則が機能）。

## 12. リスクと緩和

- **誤ヒット混入**：将来、エビデンス検証をオン。
- **順位の納得感不足**：将来、retrieval\_scoreを追加。
- **件数増によるコスト増**：将来、TopKを導入。

