# 注目特許仕分けくん システム仕様書

**バージョン**: 1.0 (MVP)  
**作成日**: 2025-08-24  
**対象システム**: 液体分離設備特許の二値分類システム

---

## 1. システム概要

### 1.1 目的
本システム「注目特許仕分けくん」は、発明アイデアと既存特許文書との技術的関連性を自動判定し、特許調査業務の効率化を図る二値分類システムである。

### 1.2 適用分野
- **主要対象**: 液体分離設備分野の特許
- **判定対象**: 発明アイデアと公開特許の技術的関連性
- **出力**: hit/miss二値分類 + 信頼度スコア + 根拠情報

### 1.3 システム性能（現バージョン）
| 項目 | 実績値 | 備考 |
|------|--------|------|
| 総合精度 | 81.5% | 目標80%を達成 |
| HIT適合率 | 80.0% | 精度と再現率のバランス |
| HIT再現率 | 80.0% | 見逃し率20%（改善対象）|
| F1スコア | 80.0% | 調和平均 |
| 処理速度 | 22秒/特許 | バッチ処理時 |
| 処理コスト | 2円/50特許 | OpenAI API使用 |

### 1.4 アーキテクチャ概要
```
[発明JSON] → [正規化] → [抽出] → [LLM処理] → [ランキング] → [CSV/JSONL出力]
              ↓         ↓        ↓           ↓
           [バリデーション][請求項1] [3段階判定] [confidence降順]
[特許JSONL]                      [抄録]
```

---

## 2. 処理フローの詳細仕様

### 2.1 全体処理フロー
システムは以下の5段階で構成される：

#### Stage 1: 正規化（Normalization）
**ファイル**: `src/core/normalize.py`  
**機能**: 入力データの標準化・検証

- **文字コード**: UTF-8への統一
- **数値単位**: メートル法への統一
- **大文字小文字**: 統一処理
- **セキュリティチェック**: 危険パターンの検出・除去

#### Stage 2: 抽出（Extraction）
**ファイル**: `src/core/extract.py`  
**機能**: 特許文書から分析対象要素を抽出

- **請求項1抽出**: 独立請求項（`is_independent: true`）を特定
- **抄録抽出**: 最大500文字でトリミング
- **フォールバック処理**: データ欠損時の代替ロジック

#### Stage 3: LLM処理（LLM Processing）
**ファイル**: `src/llm/pipeline.py`  
**機能**: 3段階のLLM分析

**3.1 発明要約生成**
- 発明アイデアの技術的核心を抽出
- 500文字以内の簡潔な要約

**3.2 特許要約生成**  
- 請求項1 + 抄録の技術要素を整理
- 発明要約との比較に最適化

**3.3 二値分類実行**
- hit/miss判定
- 信頼度スコア（0.0-1.0）
- 類似点の根拠情報

#### Stage 4: ランキング（Ranking）
**ファイル**: `src/ranking/sorter.py`  
**機能**: 結果の優先度付け

- **主ソート**: LLM信頼度降順
- **タイブレーカー**: 公開番号昇順（安定ソート）

#### Stage 5: 出力（Export）
**ファイル**: `src/core/export.py`  
**機能**: 結果のフォーマット・出力

- **CSV形式**: ランキング表示用
- **JSONL形式**: 詳細データ保存用

---

## 3. Hit/Miss判定技術（コア技術詳細）

### 3.1 判定アルゴリズムの概要

Hit/Miss判定は以下の3段階プロセスで実行される：

```
発明データ → [発明要約] → [特許要約] → [二値分類] → hit/miss + 信頼度
特許データ →            ↗            ↗
```

### 3.2 発明要約生成（Step 1）

#### 3.2.1 プロンプト設計
**システムプロンプト**:
```
あなたは特許分析の専門家です。発明アイデアを分析し、簡潔で的確な要約を作成してください。

要約の要求事項:
- 発明の核心技術と課題解決アプローチを明確に示す
- 液体分離設備分野との関連性を重視
- 技術的特徴と効果を簡潔にまとめる
- 500文字以内で要約する
- 専門用語を適切に使用し、第三者が理解できる表現にする
- 要約をJSON形式で出力し、"summary"キーにテキストを含める
```

#### 3.2.2 入力データ処理
- **必須フィールド**: title
- **オプション**: problem, solution, effects, key_elements
- **セキュリティ**: 危険パターンの除去、機密情報マスク
- **文字数制限**: 各フィールド最大2000文字

### 3.3 特許要約生成（Step 2）

#### 3.3.1 プロンプト設計
**システムプロンプト**:
```
あなたは特許分析の専門家です。特許文書を分析し、発明要約との比較のための簡潔な特許要約を作成してください。

要約の要求事項:
- 請求項1（独立請求項）と抄録の核心内容を抽出
- 技術分野、解決課題、技術手段、効果を明確に整理
- 発明要約との比較が容易な形式で整理
- 500文字以内で要約する
- 特許固有の表現は一般的な技術用語に言い換える
- 要約をJSON形式で出力し、"summary"キーにテキストを含める
```

#### 3.3.2 データ抽出仕様
- **請求項1**: `claims`配列から`is_independent: true`を検索
- **抄録**: `abstract`フィールドから最大1000文字
- **メタデータ**: 公開番号、発明名称、出願人情報
- **フォールバック**: データ欠損時は"（情報なし）"で補完

### 3.4 二値分類実行（Step 3）

#### 3.4.1 判定基準の定義
**システムプロンプト**:
```
あなたは特許分析の専門家です。発明アイデアと特許文書の技術的関連性を厳密に判定し、二値分類（hit/miss）をJSON形式で回答してください。

判定基準:
- **hit**: 発明と特許が同一技術分野で、具体的な技術的共通点が複数存在する場合
- **miss**: 技術分野が異なる、または具体的な技術的共通点が不十分な場合

信頼度の基準:
- 0.9-1.0: 明確な技術的一致、同一課題・解決手段
- 0.7-0.8: 強い技術的関連性、類似の課題・手段
- 0.5-0.6: 中程度の技術的関連性
- 0.3-0.4: 弱い関連性
- 0.0-0.2: 関連性なしまたは不明確
```

#### 3.4.2 出力JSON形式
```json
{
    "decision": "hit" | "miss",
    "confidence": 0.0-1.0（小数点2桁）,
    "hit_reason_1": "主な類似点の簡潔な説明（12語以内）",
    "hit_src_1": "claim" | "abstract",
    "hit_reason_2": "第二の類似点の簡潔な説明（12語以内）",
    "hit_src_2": "claim" | "abstract"
}
```

#### 3.4.3 信頼度算出ロジック
LLMが以下の観点から総合的に信頼度を決定：

1. **技術分野の一致度**
   - 同一分野: 0.3-0.4ベース
   - 関連分野: 0.1-0.2ベース
   - 異分野: 0.0-0.1ベース

2. **課題の類似性**
   - 同一課題: +0.2-0.3
   - 類似課題: +0.1-0.2
   - 異なる課題: +0.0

3. **解決手段の共通性**
   - 同一手段: +0.2-0.3
   - 類似手段: +0.1-0.2
   - 異なる手段: +0.0

4. **技術効果の合致**
   - 同一効果: +0.1-0.2
   - 類似効果: +0.05-0.1
   - 異なる効果: +0.0

### 3.5 根拠情報の生成

#### 3.5.1 hit_reason生成ルール
- **語数制限**: 12語以内
- **具体性**: 抽象的表現を避け、技術要素を明示
- **例**: "膜分離装置の運転データ収集機能"、"機械学習による性能予測手法"

#### 3.5.2 hit_src特定ルール
- **"claim"**: 請求項1から導出された根拠
- **"abstract"**: 抄録から導出された根拠
- 優先順位: 請求項1 > 抄録

---

## 4. データ仕様

### 4.1 入力データ仕様

#### 4.1.1 発明アイデア（JSON形式）
```json
{
    "title": "発明名称（必須）",
    "problem": "解決すべき課題（オプション）",
    "solution": "解決手段（オプション）", 
    "effects": "発明の効果（オプション）",
    "key_elements": ["技術要素1", "技術要素2"]  // オプション配列
}
```

#### 4.1.2 特許データ（JSONL形式）
```json
{
    "publication_number": "JP2025-123456A",  // 必須
    "title": "発明の名称",  // 必須
    "assignee": "出願人名",
    "pub_date": "2025-01-15",
    "claims": [
        {
            "no": 1,
            "text": "請求項の文面",
            "is_independent": true
        }
    ],
    "abstract": "要約の文面",  // 必須
    "url_hint": "https://example.com/patent/JP2025123456A"  // オプション
}
```

### 4.2 出力データ仕様

#### 4.2.1 CSV出力形式
```csv
rank,pub_number,title,assignee,pub_date,decision,LLM_confidence,hit_reason_1,hit_src_1,hit_reason_2,hit_src_2,url_hint
1,JP2025-123456A,膜分離装置,株式会社A,2025-01-15,hit,0.85,運転データ収集機能,claim,性能監視システム,abstract,https://...
```

#### 4.2.2 JSONL出力形式
```json
{
    "rank": 1,
    "publication_number": "JP2025-123456A",
    "title": "膜分離装置の監視システム",
    "assignee": "株式会社A", 
    "pub_date": "2025-01-15",
    "decision": "hit",
    "confidence": 0.85,
    "hit_reason_1": "運転データ収集機能",
    "hit_src_1": "claim",
    "hit_reason_2": "性能監視システム",
    "hit_src_2": "abstract",
    "processing_time": 21.45,
    "url_hint": "https://..."
}
```

---

## 5. LLM設定・パラメータ

### 5.1 OpenAI API設定
```yaml
llm:
  model: "gpt-4o-mini"       # コスト効率重視
  temperature: 0.0           # 決定論的出力
  response_format: "json"    # JSON強制
  max_tokens: 320           # 簡潔な応答
  timeout: 30               # タイムアウト30秒
```

### 5.2 処理設定
```yaml
processing:
  batch_size: 10            # バッチサイズ
  max_workers: 5            # 並列度
```

### 5.3 品質管理設定
- **JSONバリデーション**: 必須フィールドの存在確認
- **信頼度範囲チェック**: 0.0-1.0の範囲内
- **decision値検証**: "hit"または"miss"のみ許可

---

## 6. 性能特性・制約事項

### 6.1 現在の性能指標

#### 6.1.1 精度指標（テストデータ60件での評価）
| 指標 | 値 | 評価基準 |
|------|-----|----------|
| 総合精度（Accuracy） | 81.5% | ✅ 80%目標達成 |
| HIT適合率（Precision） | 80.0% | ✅ 良好 |
| HIT再現率（Recall） | 80.0% | ✅ 良好 |
| F1スコア | 80.0% | ✅ 良好 |
| False Negative率 | 20.0% | ⚠️ 改善対象 |

#### 6.1.2 混同行列
```
                実際
予測      HIT    MISS
HIT       20     5      ← 適合率 80%
MISS      5     24      ← 再現率 80%
```

#### 6.1.3 処理性能
- **平均処理時間**: 22秒/特許
- **スループット**: ~163特許/時間
- **API使用コスト**: 2円/50特許（GPT-4o-mini使用）
- **メモリ使用量**: 平均500MB以下

### 6.2 システム制約

#### 6.2.1 技術制約
- **ファイルサイズ制限**: 100MB/ファイル
- **同時処理数**: 最大5並列
- **処理タイムアウト**: 30分/セッション
- **API制限**: OpenAI利用制限に依存

#### 6.2.2 精度制約
- **False Negative**: 20%（見逃し率高）
- **分野依存性**: 液体分離設備分野に特化
- **言語制限**: 日本語特許のみ対応

#### 6.2.3 MVP制約
- **TopK絞り込み**: 未実装
- **検索スコア**: 未使用
- **エビデンス検証**: 未実装

---

## 7. 設定・運用仕様

### 7.1 設定ファイル（config.yaml）
```yaml
# MVP設定
run:
  use_topk: false            # TopK絞り込み無効
  use_retrieval_score: false # 検索スコア無効
  verify_quotes: false       # エビデンス検証無効

# LLM設定
llm:
  model: "gpt-4o-mini"
  temperature: 0.0
  response_format: "json"
  max_tokens: 320
  timeout: 30

# ランキング設定  
ranking:
  method: "llm_only"        # LLM信頼度のみ
  tiebreaker: "pub_number"  # 公開番号でタイブレーク

# 入出力設定
io:
  out_csv: "archive/outputs/attention_patents.csv"
  out_jsonl: "archive/outputs/details.jsonl"
  log_dir: "archive/logs"

# バッチ処理設定
processing:
  batch_size: 10
  max_workers: 5
  
# 抽出設定
extraction:
  max_abstract_length: 500
  include_dependent_claims: false
  
# ヒット理由設定
hit_reason:
  max_quote_length: 12
  max_reasons: 2
```

### 7.2 実行方法

#### 7.2.1 基本実行
```python
from src.core.screener import PatentScreener

screener = PatentScreener()
results = screener.analyze(
    invention="path/to/invention.json",
    patents="path/to/patents.jsonl"
)
```

#### 7.2.2 カスタム出力パス
```python
results = screener.analyze(
    invention="path/to/invention.json", 
    patents="path/to/patents.jsonl",
    output_csv="custom_output.csv",
    output_jsonl="custom_output.jsonl"
)
```

### 7.3 ログ・監視

#### 7.3.1 ログレベル
- **DEBUG**: 詳細な処理トレース
- **INFO**: 処理進捗・結果サマリ  
- **WARNING**: 非致命的エラー
- **ERROR**: 処理失敗・システムエラー

#### 7.3.2 統計情報取得
```python
# 処理統計の取得
stats = screener.get_processing_stats()
print(f"処理数: {stats['total_patents_processed']}")
print(f"成功数: {stats['successful_classifications']}")
print(f"平均時間: {stats['average_time_per_patent']:.2f}秒")
```

---

## 8. エラー処理・トラブルシューティング

### 8.1 エラー階層

#### 8.1.1 システムエラー
- **ScreenerConfigError**: 設定ファイル関連
- **ScreenerInputError**: 入力データ関連
- **ScreenerProcessingError**: 処理実行関連
- **ScreenerOutputError**: 出力関連

#### 8.1.2 LLMエラー
- **PipelineError**: パイプライン処理エラー
- **PipelineConfigError**: パイプライン設定エラー
- **PromptValidationError**: プロンプト検証エラー
- **PromptSecurityError**: セキュリティ違反検出

### 8.2 一般的な問題と解決策

#### 8.2.1 API関連
**問題**: OpenAI API key未設定
```
解決策: 環境変数OPENAI_API_KEYを設定
export OPENAI_API_KEY="sk-..."
```

**問題**: API利用制限に達した
```
解決策: config.yamlでmax_workersを減らす
processing:
  max_workers: 1  # 並列度を下げる
```

#### 8.2.2 データ関連
**問題**: 特許データが不完全
```
解決策: continue_on_error=Trueで実行
results = screener.analyze(..., continue_on_error=True)
```

**問題**: JSON解析エラー
```
解決策: ファイル形式・エンコーディングの確認
- UTF-8エンコーディング
- 改行区切りJSONL形式
```

#### 8.2.3 性能関連
**問題**: 処理速度が遅い
```
解決策1: バッチサイズを調整
processing:
  batch_size: 5  # より小さなバッチ

解決策2: 並列度を上げる  
processing:
  max_workers: 10  # API制限内で調整
```

---

## 9. 拡張・改善計画（v2開発方針）

### 9.1 精度改善計画

#### 9.1.1 False Negative削減（優先度：高）
**現状**: 20%のFalse Negative（見逃し率）  
**目標**: 8%未満への削減

**改善策**:
1. **多段階判定システム**
   - 初回判定 → 再評価判定 → 保守的判定
   - アンサンブル投票による最終決定

2. **信頼度閾値の最適化**
   - HIT判定閾値: 0.5 → 0.3に引き下げ
   - 段階的閾値による感度調整

3. **プロンプト改良**
   - より具体的な判定基準の追加
   - 境界事例の明確化

#### 9.1.2 判定品質向上
1. **コンテキスト拡張**
   - 従属請求項の活用
   - 背景技術情報の考慮

2. **ドメイン特化**
   - 液体分離設備専門用語の強化
   - 技術分類体系の導入

### 9.2 機能拡張計画

#### 9.2.1 検索機能拡張
1. **TopK絞り込み**
   - キーワードベース事前フィルタリング
   - ベクトル検索による類似度計算

2. **ハイブリッドスコアリング**
   - LLM信頼度 + 検索スコア
   - 重み付け最適化

#### 9.2.2 データ処理拡張
1. **Excel-to-JSONL変換**
   - 自動データ変換パイプライン
   - データ品質検証機能

2. **多言語対応**
   - 英語特許の処理対応
   - 翻訳機能の統合

### 9.3 システム改善

#### 9.3.1 性能最適化
1. **処理速度向上**
   - 並列処理の最適化
   - キャッシュ機能の導入

2. **スケーラビリティ**
   - 大容量データ処理対応
   - クラウド展開対応

#### 9.3.2 運用性向上
1. **UI/UX改善**
   - Web UI の提供
   - 進捗表示の改善

2. **監視・分析**
   - リアルタイム監視
   - 性能分析ダッシュボード

---

## 10. 付録

### 10.1 参考ドキュメント
- `CLAUDE.md`: プロジェクト概要・開発ガイド
- `archive/reports/`: 性能評価レポート
- `testing/`: テストケース・検証データ
- `要件定義書_v2.md`: v2開発要件

### 10.2 技術スタック
- **言語**: Python 3.8+
- **LLM API**: OpenAI GPT-4o-mini
- **ライブラリ**: loguru, yaml, pathlib, concurrent.futures
- **テスト**: pytest
- **バージョン管理**: Git

### 10.3 ライセンス・制約
- OpenAI利用規約に準拠
- 商用利用可能（APIコストは別途）
- 日本国内の特許法に準拠した運用

---

**文書更新履歴**
- v1.0 (2025-08-24): 初版作成（MVPシステム仕様）
- 今後の更新: v2開発に伴い仕様拡張予定